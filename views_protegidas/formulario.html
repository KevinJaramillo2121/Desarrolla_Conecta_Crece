<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Formulario de Inscripción - Desarrolla, Conecta y Crece</title>
<style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
        }
        .checkbox-group {
            margin: 10px 0;
        }
        .checkbox-group label {
            display: inline-block;
            margin-left: 5px;
            font-weight: normal;
        }
        .required:after {
            content: " *";
            color: red;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .file-upload {
            margin: 10px 0;
        }
</style>
</head>
<body>
<div id="reloj-convocatoria" style="font-weight: bold; font-size: 18px; margin-bottom: 20px;">
Cargando fecha de cierre...
</div>
<div class="container">
<h1>Formulario de Inscripción: Desarrolla, Conecta y Crece</h1>
<p><strong>Convocatoria dirigida a MiPymes agroalimentarias afiliadas a Comfama ubicadas en Antioquia</strong></p>

<form id="inscripcionForm" enctype="multipart/form-data">
<!-- Sección 1: Información general de la empresa -->
<div class="form-section">
<h2>1. Información general de la empresa</h2>
<div class="form-group">
<label class="required" for="nombre_legal">Nombre legal de la empresa:</label>
<input id="nombre_legal" name="nombre_legal" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="nit">NIT:</label>
<input id="nit" name="nit" required="" type="text"/>
</div>
<div class="form-group">
<label class="required">Persona jurídica:</label>
<div class="checkbox-group">
<input id="persona_juridica_si" name="persona_juridica" required="" type="radio" value="true"/>
<label for="persona_juridica_si">Sí</label>
<input id="persona_juridica_no" name="persona_juridica" type="radio" value="false"/>
<label for="persona_juridica_no">No</label>
</div>
</div>
<div class="form-group">
<label class="required" for="tipo_empresa">Tipo de empresa:</label>
<select id="tipo_empresa" name="tipo_empresa" required="">
<option value="">Seleccione...</option>
<option value="Micro">Micro</option>
<option value="Pequeña">Pequeña</option>
<option value="Mediana">Mediana</option>
</select>
</div>
<div class="form-group">
<label>Certificado de tamaño empresarial adjunto:</label>
<div class="checkbox-group">
<input id="certificado_tamano" name="certificado_tamano" type="checkbox" value="true"/>
<label for="certificado_tamano">Sí</label>
</div>
<div class="file-upload">
<input id="certificado_tamano_file" name="certificado_tamano_file" type="file"/>
</div>
</div>
<div class="form-group">
<label class="required" for="representante">Representante legal:</label>
<input id="representante" name="representante" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="cedula_representante">Número de cédula del representante:</label>
<input id="cedula_representante" name="cedula_representante" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="correo_contacto">Correo electrónico de contacto:</label>
<input id="correo_contacto" name="correo_contacto" required="" type="email"/>
</div>
<div class="form-group">
<label class="required" for="telefono_contacto">Teléfono de contacto:</label>
<input id="telefono_contacto" name="telefono_contacto" required="" type="tel"/>
</div>
<div class="form-group">
<label class="required" for="municipio">Municipio y dirección de la sede principal:</label>
<input id="municipio" name="municipio" placeholder="Municipio" required="" type="text"/>
<textarea id="direccion" name="direccion" placeholder="Dirección completa" required=""></textarea>
</div>
<div class="form-group">
<label>¿Está ubicada fuera del Valle de Aburrá?</label>
<div class="checkbox-group">
<input id="fuera_valle_si" name="fuera_valle" type="radio" value="true"/>
<label for="fuera_valle_si">Sí</label>
<input checked="" id="fuera_valle_no" name="fuera_valle" type="radio" value="false"/>
<label for="fuera_valle_no">No</label>
</div>
</div>
<div class="form-group">
<label>¿Está afiliada a Comfama?</label>
<div class="checkbox-group">
<input id="afiliada_comfama_si" name="afiliada_comfama" type="radio" value="true"/>
<label for="afiliada_comfama_si">Sí</label>
<input checked="" id="afiliada_comfama_no" name="afiliada_comfama" type="radio" value="false"/>
<label for="afiliada_comfama_no">No</label>
</div>
</div>
<div class="form-group">
<label>¿Cuenta con al menos un trabajador afiliado a Comfama?</label>
<div class="checkbox-group">
<input id="tiene_trabajador_si" name="tiene_trabajador" type="radio" value="true"/>
<label for="tiene_trabajador_si">Sí</label>
<input checked="" id="tiene_trabajador_no" name="tiene_trabajador" type="radio" value="false"/>
<label for="tiene_trabajador_no">No</label>
</div>
</div>
<div class="form-group">
<label class="required" for="parafiscales">Certificado de parafiscales vigente (últimos 6 meses):</label>
<div class="file-upload">
<input id="parafiscales" name="parafiscales" required="" type="file"/>
</div>
</div>
</div>

<!-- Sección 2: Producto o proyecto a postular -->
<div class="form-section">
<h2>2. Producto o proyecto a postular</h2>
<p>Esta sección tiene como objetivo identificar el punto de partida técnico, normativo y comercial de su producto o idea.</p>
<h3>2.1. Información general</h3>
<div class="form-group">
<label class="required" for="nombre_producto">Nombre del producto actual o idea a desarrollar:</label>
<input id="nombre_producto" name="nombre_producto" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="descripcion_producto">Descripción detallada del producto o idea:</label>
<textarea id="descripcion_producto" name="descripcion_producto" required=""></textarea>
<small>(Composición, uso previsto, tipo de consumidor, categoría)</small>
</div>
<div class="form-group">
<label class="required">¿Cuál es el estado actual del producto o idea?</label>
<div class="checkbox-group">
<input id="estado_idea" name="estado_producto" required="" type="radio" value="En idea/concepto"/>
<label for="estado_idea">En idea/concepto</label><br/>
<input id="estado_prototipo" name="estado_producto" type="radio" value="En desarrollo inicial (prototipo)"/>
<label for="estado_prototipo">En desarrollo inicial (prototipo)</label><br/>
<input id="estado_comercializado" name="estado_producto" type="radio" value="Producto comercializado localmente"/>
<label for="estado_comercializado">Producto comercializado localmente</label><br/>
<input id="estado_proyeccion" name="estado_producto" type="radio" value="Producto con proyección internacional"/>
<label for="estado_proyeccion">Producto con proyección internacional</label><br/>
<input id="estado_otro" name="estado_producto" type="radio" value="Otro"/>
<label for="estado_otro">Otro (especificar):</label>
<input disabled="" id="estado_otro_texto" name="estado_otro_texto" type="text"/>
</div>
</div>
<div class="form-group">
<label class="required" for="mercado_objetivo">¿Cuál es el público o mercado objetivo de este producto?</label>
<textarea id="mercado_objetivo" name="mercado_objetivo" required=""></textarea>
</div>

<h3>2.2. Brechas que desea cerrar</h3>
<p>Por favor describa las brechas o necesidades que su empresa ha identificado en relación con su producto.</p>
<div class="form-group">
<label><strong>1. Brechas técnicas del producto (funcionalidad, formulación, desempeño):</strong></label>
<div class="checkbox-group">
<input id="brecha_tecnica" name="brechas[]" type="checkbox" value="Brechas técnicas"/>
<label for="brecha_tecnica">Sí (explique):</label>
</div>
<textarea id="brecha_tecnica_desc" name="brecha_tecnica_desc" placeholder="¿Qué desafíos técnicos presenta actualmente su producto? ¿Qué desea validar, reformular o mejorar? ¿Existen dificultades relacionadas con la estabilidad del producto, la textura, sabor, color, vida útil u otra propiedad?"></textarea>
</div>
<div class="form-group">
<label><strong>2. Brechas en el cumplimiento normativo:</strong></label>
<div class="checkbox-group">
<input id="brecha_normativa" name="brechas[]" type="checkbox" value="Brechas normativas"/>
<label for="brecha_normativa">Sí (explique):</label>
</div>
<textarea id="brecha_normativa_desc" name="brecha_normativa_desc" placeholder="¿Su producto cumple con los requisitos exigidos por INVIMA, FDA, EFSA u otra entidad reguladora? ¿Qué normativa específica representa una barrera?"></textarea>
</div>
<div class="form-group">
<label><strong>3. Brechas en el análisis y validación de calidad:</strong></label>
<div class="checkbox-group">
<input id="brecha_calidad" name="brechas[]" type="checkbox" value="Brechas de calidad"/>
<label for="brecha_calidad">Sí (explique):</label>
</div>
<textarea id="brecha_calidad_desc" name="brecha_calidad_desc" placeholder="¿Ha realizado análisis fisicoquímicos, microbiológicos, etc.? ¿Qué análisis considera fundamentales? ¿Tiene dificultades para interpretar resultados?"></textarea>
</div>
<div class="form-group">
<label><strong>4. Brechas relacionadas con el empaque y conservación:</strong></label>
<div class="checkbox-group">
<input id="brecha_empaque" name="brechas[]" type="checkbox" value="Brechas de empaque"/>
<label for="brecha_empaque">Sí (explique):</label>
</div>
<textarea id="brecha_empaque_desc" name="brecha_empaque_desc" placeholder="¿Considera que el empaque actual es adecuado? ¿Ha tenido problemas de vida útil, fugas, deterioro? ¿Desea evaluar nuevos materiales?"></textarea>
</div>
<div class="form-group">
<label><strong>5. Brechas en posicionamiento y acceso a mercado:</strong></label>
<div class="checkbox-group">
<input id="brecha_mercado" name="brechas[]" type="checkbox" value="Brechas de mercado"/>
<label for="brecha_mercado">Sí (explique):</label>
</div>
<textarea id="brecha_mercado_desc" name="brecha_mercado_desc" placeholder="¿Qué obstáculos ha identificado para acceder a mercados? ¿El producto tiene atributos diferenciadores? ¿Qué ajustes considera necesarios?"></textarea>
</div>
<div class="form-group">
<label for="otras_brechas"><strong>6. Otras brechas o necesidades específicas no contempladas anteriormente:</strong></label>
<textarea id="otras_brechas" name="otras_brechas"></textarea>
</div>
</div>

<!-- Sección 7: Proyección estratégica -->
<div class="form-section">
<h2>7. Proyección estratégica del producto</h2>
<div class="form-group">
<label class="required" for="vision_producto">7.1 ¿Cuál es su visión para este producto en los próximos 12 a 24 meses?</label>
<textarea id="vision_producto" name="vision_producto" required=""></textarea>
<small>Describa qué espera lograr en términos de posicionamiento, alcance comercial, transformaciones técnicas, cumplimiento normativo y atributos diferenciadores.</small>
</div>
<div class="form-group">
<label class="required" for="impacto_empresa">7.2 ¿Qué impacto espera que este producto tenga dentro de su empresa y/o en su comunidad (económico, social, ambiental)?</label>
<textarea id="impacto_empresa" name="impacto_empresa" required=""></textarea>
</div>
<div class="form-group">
<label class="required" for="compromisos">7.3 ¿Qué compromisos está dispuesta su empresa a asumir para alcanzar esta visión (tiempo, recursos, equipo, inversión)?</label>
<textarea id="compromisos" name="compromisos" required=""></textarea>
</div>
</div>

<!-- Sección 8: Motivación y expectativas -->
<div class="form-section">
<h2>8. Motivación y expectativas</h2>
<div class="form-group">
<label class="required" for="motivacion">¿Por qué desea participar en la convocatoria Desarrolla, Conecta y Crece?</label>
<textarea id="motivacion" name="motivacion" required=""></textarea>
</div>
<div class="form-group">
<label class="required" for="expectativas">¿Qué espera lograr con este acompañamiento técnico?</label>
<textarea id="expectativas" name="expectativas" required=""></textarea>
</div>
<div class="form-group">
<label class="required">¿Está dispuesta su empresa a dedicar tiempo al diagnóstico, participación en Bootcamps y seguimiento técnico durante los próximos meses?</label>
<div class="checkbox-group">
<input id="disponibilidad_si" name="disponibilidad" required="" type="radio" value="true"/>
<label for="disponibilidad_si">Sí</label>
<input id="disponibilidad_no" name="disponibilidad" type="radio" value="false"/>
<label for="disponibilidad_no">No</label>
</div>
</div>
</div>

<!-- Sección 9: Documentos requeridos -->
<div class="form-section">
<h2>9. Documentos requeridos (adjuntar)</h2>
<div class="form-group">
<label class="required" for="camara_comercio">Cámara de comercio (vigente):</label>
<div class="file-upload">
<input id="camara_comercio" name="camara_comercio" required="" type="file" accept=".pdf"/>
</div>
</div>
<div class="form-group">
<label class="required" for="rut">RUT actualizado:</label>
<div class="file-upload">
<input id="rut" name="rut" required="" type="file"/>
</div>
</div>
<div class="form-group">
<label for="afiliacion_comfama">Certificado de afiliación a Comfama:</label>
<div class="file-upload">
<input id="afiliacion_comfama" name="afiliacion_comfama" type="file" accept=".pdf"/>
</div>
</div>
<div class="form-group">
<label for="hoja_vida">Hoja de vida del producto (si aplica):</label>
<div class="file-upload">
<input id="hoja_vida" name="hoja_vida" type="file" accept=".pdf"/>
</div>
</div>
<div class="form-group">
<label for="otros_documentos">Otro soporte técnico (opcional):</label>
<div class="file-upload">
<input id="otros_documentos" name="otros_documentos" type="file" accept=".pdf"/>
</div>
</div>
</div>

<!-- Sección 10: Declaración -->
<div class="form-section">
<h2>10. Declaración</h2>
<p>Declaro que la información aquí consignada es veraz y autorizo su uso en el marco de la presente convocatoria por parte de Aoxlab y Comfama.</p>
<div class="form-group">
<label class="required" for="nombre_representante">Nombre completo del representante legal:</label>
<input id="nombre_representante" name="nombre_representante" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="cedula_representante_declaracion">Número de cédula:</label>
<input id="cedula_representante_declaracion" name="cedula_representante_declaracion" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="firma">Firma:</label>
<input id="firma" name="firma" placeholder="Escriba su nombre como firma digital" required="" type="text"/>
</div>
<div class="form-group">
<label class="required" for="fecha_declaracion">Fecha:</label>
<input id="fecha_declaracion" name="fecha_declaracion" required="" type="date"/>
</div>
</div>

<div style="margin-top: 20px;">
    <button type="button" id="btn-guardar-borrador">💾 Guardar como borrador</button>
    <button type="button" id="btn-enviar">✅ Enviar postulación</button>
</div>

</form>
</div>

<script>
    async function obtenerFechaCierre() {
        try {
            const response = await fetch('/participante/fecha-cierre');
            const data = await response.json();
            return new Date(data.fechaFin);
        } catch (error) {
            console.error('Error al obtener fecha de cierre:', error);
            return null;
        }
    }

    function iniciarCuentaRegresiva(fechaCierre) {
        const reloj = document.getElementById('reloj-convocatoria');
        const formulario = document.getElementById('inscripcionForm');

        function actualizarReloj() {
            const ahora = new Date();
            const diferencia = fechaCierre - ahora;

            if (diferencia <= 0) {
                reloj.textContent = '⛔ La convocatoria ha cerrado.';
                if (formulario) {
                    formulario.querySelectorAll('input, textarea, select, button').forEach(elem => {
                        elem.disabled = true;
                    });
                }
                clearInterval(intervalo);
                return;
            }

            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diferencia / (1000 * 60 * 60)) % 24);
            const minutos = Math.floor((diferencia / (1000 * 60)) % 60);
            const segundos = Math.floor((diferencia / 1000) % 60);

            reloj.textContent = `⏳ Tiempo restante: ${dias}d ${horas}h ${minutos}m ${segundos}s`;
        }

        actualizarReloj();
        const intervalo = setInterval(actualizarReloj, 1000);
    }

    async function validarEstadoPostulacion() {
        try {
            const res = await fetch('/participante/estado-postulacion');
            const data = await res.json();
            if (data.estado === 'enviado') {
                document.getElementById('reloj-convocatoria').textContent = '✅ Ya enviaste tu postulación.';
                const formulario = document.getElementById('inscripcionForm');
                formulario.querySelectorAll('input, textarea, select, button').forEach(elem => {
                    elem.disabled = true;
                });
            }
        } catch (error) {
            console.error('Error al validar estado:', error);
        }
    }

    function recolectarDatosDelFormulario() {
        return {
            producto_info: {
                nombre: document.getElementById('nombre_producto').value,
                descripcion: document.getElementById('descripcion_producto').value,
                estado_producto: document.querySelector('input[name="estado_producto"]:checked')?.value || '',
                mercado_objetivo: document.getElementById('mercado_objetivo').value
            },
            brechas: {
                tecnicas: document.getElementById('brecha_tecnica_desc').value,
                normativas: document.getElementById('brecha_normativa_desc').value,
                calidad: document.getElementById('brecha_calidad_desc').value,
                empaque: document.getElementById('brecha_empaque_desc').value,
                mercado: document.getElementById('brecha_mercado_desc').value,
                otras: document.getElementById('otras_brechas').value
            },
            motivacion: {
                vision: document.getElementById('vision_producto').value,
                impacto: document.getElementById('impacto_empresa').value,
                compromisos: document.getElementById('compromisos').value,
                motivo: document.getElementById('motivacion').value,
                expectativa: document.getElementById('expectativas').value,
                disponible: document.querySelector('input[name="disponibilidad"]:checked')?.value === 'true'
            }
        };
    }

    async function guardarComoBorrador() {
    try {
        const producto_info = {
            nombre: document.getElementById('nombre_producto').value || '',
            descripcion: document.getElementById('descripcion_producto').value || '',
            estado_producto: document.querySelector('input[name="estado_producto"]:checked')?.value || '',
            mercado_objetivo: document.getElementById('mercado_objetivo').value || ''
        };

        const brechas = {
            tecnicas: document.getElementById('brecha_tecnica_desc').value || '',
            normativas: document.getElementById('brecha_normativa_desc').value || '',
            calidad: document.getElementById('brecha_calidad_desc').value || '',
            empaque: document.getElementById('brecha_empaque_desc').value || '',
            mercado: document.getElementById('brecha_mercado_desc').value || '',
            otras: document.getElementById('otras_brechas').value || ''
        };

        const motivacion = {
            vision: document.getElementById('vision_producto').value || '',
            impacto: document.getElementById('impacto_empresa').value || '',
            compromisos: document.getElementById('compromisos').value || '',
            motivo: document.getElementById('motivacion').value || '',
            expectativa: document.getElementById('expectativas').value || '',
            disponible: document.querySelector('input[name="disponibilidad"]:checked')?.value === 'true'
        };

        const datos = {
            producto_info: JSON.stringify(producto_info),
            brechas: JSON.stringify(brechas),
            motivacion: JSON.stringify(motivacion)
        };

        console.log('Guardando borrador:', datos);

        const res = await fetch('/participante/guardar-borrador', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });
        const data = await res.json();
        alert(data.mensaje || data.error);
    } catch (error) {
        alert('Error al guardar borrador.');
        console.error(error);
    }
}


    async function enviarPostulacion() {
    const confirmacion = confirm('¿Estás seguro de enviar tu postulación? Ya no podrás modificarla.');
    if (!confirmacion) return;

    // Validar cédulas coincidentes
    const cedula1 = document.getElementById('cedula_representante').value;
    const cedula2 = document.getElementById('cedula_representante_declaracion').value;
    if (cedula1 !== cedula2) {
        alert('El número de cédula en la declaración no coincide con el proporcionado anteriormente.');
        return;
    }

    try {
        const form = document.getElementById('inscripcionForm');
        const formData = new FormData(form);

        // Construir los objetos complejos
        const producto_info = {
            nombre: document.getElementById('nombre_producto').value || '',
            descripcion: document.getElementById('descripcion_producto').value || '',
            estado_producto: document.querySelector('input[name="estado_producto"]:checked')?.value || '',
            mercado_objetivo: document.getElementById('mercado_objetivo').value || ''
        };

        const brechas = {
            tecnicas: document.getElementById('brecha_tecnica_desc').value || '',
            normativas: document.getElementById('brecha_normativa_desc').value || '',
            calidad: document.getElementById('brecha_calidad_desc').value || '',
            empaque: document.getElementById('brecha_empaque_desc').value || '',
            mercado: document.getElementById('brecha_mercado_desc').value || '',
            otras: document.getElementById('otras_brechas').value || ''
        };

        const motivacion = {
            vision: document.getElementById('vision_producto').value || '',
            impacto: document.getElementById('impacto_empresa').value || '',
            compromisos: document.getElementById('compromisos').value || '',
            motivo: document.getElementById('motivacion').value || '',
            expectativa: document.getElementById('expectativas').value || '',
            disponible: document.querySelector('input[name="disponibilidad"]:checked')?.value === 'true'
        };

        // Limpiar campos del FormData
        formData.delete('producto_info');
        formData.delete('brechas');
        formData.delete('motivacion');

        // Agregar objetos como strings JSON válidos
        formData.append('producto_info', JSON.stringify(producto_info));
        formData.append('brechas', JSON.stringify(brechas));
        formData.append('motivacion', JSON.stringify(motivacion));

        console.log('=== DEBUG ENVÍO ===');
        console.log('producto_info:', JSON.stringify(producto_info));
        console.log('brechas:', JSON.stringify(brechas));
        console.log('motivacion:', JSON.stringify(motivacion));
        
        // Ver todos los datos del FormData
        console.log('=== FormData completo ===');
        for (let [key, value] of formData.entries()) {
            console.log(key, ':', typeof value === 'object' ? '[File]' : value);
        }

        const res = await fetch('/participante/enviar-postulacion', {
            method: 'POST',
            body: formData
        });

        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);

        if (!res.ok) {
            const errorText = await res.text();
            console.error('Error response:', errorText);
            alert(`Error ${res.status}: ${errorText}`);
            return;
        }

        const data = await res.json();
        console.log('Success response:', data);
        alert(data.mensaje || data.error);
        if (res.ok) location.reload();
    } catch (error) {
        console.error('Catch error:', error);
        alert('Error al enviar la postulación: ' + error.message);
    }
}


    // Habilitar campo "Otro" cuando se selecciona
    document.getElementById('estado_otro').addEventListener('change', function() {
        document.getElementById('estado_otro_texto').disabled = !this.checked;
    });

    document.addEventListener('DOMContentLoaded', async () => {
        await validarEstadoPostulacion();

        const fechaCierre = await obtenerFechaCierre();
        if (fechaCierre) iniciarCuentaRegresiva(fechaCierre);

        document.getElementById('btn-guardar-borrador').addEventListener('click', guardarComoBorrador);
        document.getElementById('btn-enviar').addEventListener('click', enviarPostulacion);
    });
</script>

</body>
</html>
